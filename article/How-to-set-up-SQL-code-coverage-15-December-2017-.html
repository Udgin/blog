<!DOCTYPE html>
<html lang="en">

<head>
    <title>How to set up SQL code coverage - 15 December, 2017-</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="mssql,code coverage,sql,dotnet">
    <meta name="author" content="Eugene Pyl">
    <link rel="icon" href="./../favicon.ico" />
    <link rel="stylesheet" href="./../prism.css">
    
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
    <script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5906f3ca75e4e1001109c19a&product=inline-share-buttons"></script>
    <style>
        img {
            max-width: 100%;
            height: auto;
            width: auto\9;
            /* ie8 */
        }
        
        body {
            font-family: 'Verdana', sans-serif;
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 1rem;
            background-color: #fcfcfc;
        }
        
        h2 {
            font-size: 1.3rem;
        }
        
        code.has-jax {
            font: inherit;
            font-size: 100%;
            background: inherit;
            border: inherit;
        }
        
        .night body {
            background: #fffedd;
        }
        
        .markdown-body pre {
            border: 1px solid black;
        }
        
        div.shareit {
            margin-top: 0.5rem;
        }
        
        article>h2 {
            margin-top: 0;
        }
    </style>
</head>

<body>
    <article class="markdown-body">
        <h2 id="how-to-set-up-sql-code-coverage-15-december-2017-">How to set up SQL code coverage - 15 December, 2017-</h2>
<p>Tags: mssql, code coverage, sql, dotnet</p>
<p>If you are creating a lot of SQL code, it is a good idea to do unit testing for it and see <a href="https://en.wikipedia.org/wiki/Code_coverage">code coverage</a>. Luckly there is two nice tools/libs to do it: <a href="http://tsqlt.org/">tSQLt</a> and <a href="https://github.com/GoEddie/SQLCover">SQLCover</a>.</p>
<p>In this article I will show how to create/set up SQLCover and run it for each CI build.
The basic idea is we are creating command line application which runs our tSQLt unit tests via SQLCover and generates HTML report with code coverage information.</p>
<p>Unfortunately there is no SQLCover package in NuGet, but we can download it from <a href="http://the.agilesql.club/SQLCover/download.php">here</a>.</p>
<p>Create a new command line application, add references to SQLCover.dll and Microsoft.SqlServer.TransactSql.ScriptDom.dll.
After that there is an example of Program.cs:</p>
<pre><code class="language-csharp">    private const string RunAllSqlTestsCommand = &quot;exec tSQLt.RunAll;&quot;;
    private const string DefaultDatabaseName = &quot;MyDB&quot;;

    private const string ReportName = &quot;SQLCoverage.html&quot;;

    static void Main(string[] args)
    {
        var connectionString = ConfigurationManager.ConnectionStrings[DefaultDatabaseName].ConnectionString;
        var coverage = new CodeCoverage(connectionString, DefaultDatabaseName);
        var result = coverage.Cover(RunAllSqlTestsCommand);
        var updatedResult =  result.Html();
        File.WriteAllText(ReportName, updatedResult);
    }
</code></pre>
<p>After execution you will see SQLCoverage.html with code coverage statistics in the same folder.</p>
<p>One note from SQLCover owner: &quot;When we target local sql instances we delete the trace files but when targetting remote instances we are unable to delete the files as we do not (or potentially) do not have access. If this is the case keep an eye on the log directory and remove old &quot;SQLCover-Trace-.xel&quot; and &quot;SQLCover-Trace-.xem&quot; files.&quot;</p>
<p>Thanks.</p>

    </article>
    <div class="sharethis-inline-share-buttons"></div>
    <div id="disqus_thread"></div>
    <script>
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document,
                s = d.createElement('script');
            s.src = '//eapyl-github-io.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <script>
        function timeCheck() {
            var currentTime = new Date().getHours();
            if (currentTime > 18 || currentTime < 6) {
                document.documentElement.classList.add('night');
            } else {
                document.documentElement.classList.remove('night');
            }
        }
        timeCheck();
        setInterval(timeCheck(), 1000 * 60 * 60);
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'] } }); MathJax.Hub.Queue(function() { // Fix <code> tags after MathJax finishes running. This is a
        // hack to overcome a shortcoming of Markdown. Discussion at
        // https://github.com/mojombo/jekyll/issues/199
        var all = MathJax.Hub.getAllJax(), i;
        for(i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
    </script>
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-87583712-1', 'auto');
    ga('send', 'pageview');

</script>
<script src="./../prism.js"></script>
</body>

</html>