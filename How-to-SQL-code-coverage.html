<title>How to set up SQL code coverage</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css><link rel=stylesheet href=prism.css><link><style>.content .tag,.content .number{display:inline;padding:inherit;font-size:inherit;line-height:inherit;text-align:inherit;vertical-align:inherit;border-radius:inherit;font-weight:inherit;white-space:inherit;background:inherit;margin:inherit}</style><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=index.html><img src=favicon.ico width=28 height=28>Â Programming notes</a> <a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden></span> <span aria-hidden></span> <span aria-hidden></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-start><div class=navbar-item><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link>About me</a><div class=navbar-dropdown> <a class=navbar-item href=https://www.facebook.com/yauhen.pyl>Facebook</a> <a class=navbar-item href=https://pl.linkedin.com/in/yauhenpyl>LinkedIn</a> <a class=navbar-item href=https://github.com/eapyl>GitHub</a> <a class=navbar-item href=mailto:gromkaktus@gmail.com>Email</a></div></div></div></div></div></nav><section class=section><div class=container><div class=content><h1 id=how-to-set-up-sql-code-coverage>How to set up SQL code coverage</h1><p>If you are creating a lot of SQL code, it is a good idea to do unit testing for it and see <a href=https://en.wikipedia.org/wiki/Code_coverage>code coverage</a>. Luckly there is two nice tools/libs to do it: <a href=http://tsqlt.org/ >tSQLt</a> and <a href=https://github.com/GoEddie/SQLCover>SQLCover</a>.<p>In this article I will show how to create/set up SQLCover and run it for each CI build. The basic idea is we are creating command line application which runs our tSQLt unit tests via SQLCover and generates HTML report with code coverage information.<p>Unfortunately there is no SQLCover package in NuGet, but we can download it from <a href=http://the.agilesql.club/SQLCover/download.php>here</a>.<p>Create a new command line application, add references to SQLCover.dll and Microsoft.SqlServer.TransactSql.ScriptDom.dll. After that there is an example of Program.cs:
<pre><code class=language-csharp>    private const string RunAllSqlTestsCommand = "exec tSQLt.RunAll;";
    private const string DefaultDatabaseName = "MyDB";

    private const string ReportName = "SQLCoverage.html";

    static void Main(string[] args)
    {
        var connectionString = ConfigurationManager.ConnectionStrings[DefaultDatabaseName].ConnectionString;
        var coverage = new CodeCoverage(connectionString, DefaultDatabaseName);
        var result = coverage.Cover(RunAllSqlTestsCommand);
        var updatedResult =  result.Html();
        File.WriteAllText(ReportName, updatedResult);
    }
</code></pre><p>After execution you will see SQLCoverage.html with code coverage statistics in the same folder.<p>One note from SQLCover owner: "When we target local sql instances we delete the trace files but when targetting remote instances we are unable to delete the files as we do not (or potentially) do not have access. If this is the case keep an eye on the log directory and remove old "SQLCover-Trace-.xel" and "SQLCover-Trace-.xem" files."<p>Thanks.</div><div><div class=sharethis-inline-share-buttons></div></div></div></section><script async src=prism.js></script><script>(function(n,t,i,r,u,f,e){n.GoogleAnalyticsObject=u;n[u]=n[u]||function(){(n[u].q=n[u].q||[]).push(arguments)};n[u].l=1*new Date;f=t.createElement(i);e=t.getElementsByTagName(i)[0];f.async=1;f.src=r;e.parentNode.insertBefore(f,e)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create","UA-87583712-1","auto");ga("send","pageview")</script><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5906f3ca75e4e1001109c19a&product=inline-share-buttons"></script>