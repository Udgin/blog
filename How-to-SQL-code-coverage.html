<title>How-to-SQL-code-coverage</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-exp.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-icons.min.css><link rel=stylesheet href=prism.css><link><style>.columns .column{padding:.4rem}#sidebar-id{padding:.4rem}code{padding:0;overflow-x:scroll}img{max-width:100%}.off-canvas .off-canvas-sidebar{background:none}</style><div class="off-canvas off-canvas-sidebar-show"><a class="off-canvas-toggle btn btn-primary btn-action" href=#sidebar-id><i class="icon icon-menu"></i></a><div id=sidebar-id class=off-canvas-sidebar><ul class=menu><li class=menu-item><div class="tile tile-centered"><div class=tile-icon><img class=avatar src="https://media.licdn.com/dms/image/C4E03AQEtgQbQGiCpUQ/profile-displayphoto-shrink_200_200/0?e=1547683200&v=beta&t=YKT1NVMDvlzVocWQtSP2Y6Z4Eoy-fqPLncAIk45nF2U" alt=Avatar></div><div class=tile-content>Yauhen Pyl</div></div><li class=divider data-content=LINKS><li class=menu-item><a href=https://plus.google.com/+UdginPyl>Google+</a><li class=menu-item><a href=https://www.facebook.com/yauhen.pyl>Facebook</a><li class=menu-item><a href=https://pl.linkedin.com/in/eugenepyl>LinkedIn</a><li class=menu-item><a href=https://github.com/eapyl>GitHub</a><li class=menu-item><a href=mailto:gromkaktus@gmail.com>Email</a></ul></div><a class=off-canvas-overlay href=#close></a><div class=off-canvas-content><div class="container grid-lg"><article><h1 id=how-to-set-up-sql-code-coverage>How to set up SQL code coverage</h1><p>If you are creating a lot of SQL code, it is a good idea to do unit testing for it and see <a href=https://en.wikipedia.org/wiki/Code_coverage>code coverage</a>. Luckly there is two nice tools/libs to do it: <a href=http://tsqlt.org/ >tSQLt</a> and <a href=https://github.com/GoEddie/SQLCover>SQLCover</a>.<p>In this article I will show how to create/set up SQLCover and run it for each CI build. The basic idea is we are creating command line application which runs our tSQLt unit tests via SQLCover and generates HTML report with code coverage information.<p>Unfortunately there is no SQLCover package in NuGet, but we can download it from <a href=http://the.agilesql.club/SQLCover/download.php>here</a>.<p>Create a new command line application, add references to SQLCover.dll and Microsoft.SqlServer.TransactSql.ScriptDom.dll. After that there is an example of Program.cs:
<pre><code class=language-csharp>    private const string RunAllSqlTestsCommand = "exec tSQLt.RunAll;";
    private const string DefaultDatabaseName = "MyDB";

    private const string ReportName = "SQLCoverage.html";

    static void Main(string[] args)
    {
        var connectionString = ConfigurationManager.ConnectionStrings[DefaultDatabaseName].ConnectionString;
        var coverage = new CodeCoverage(connectionString, DefaultDatabaseName);
        var result = coverage.Cover(RunAllSqlTestsCommand);
        var updatedResult =  result.Html();
        File.WriteAllText(ReportName, updatedResult);
    }
</code></pre><p>After execution you will see SQLCoverage.html with code coverage statistics in the same folder.<p>One note from SQLCover owner: "When we target local sql instances we delete the trace files but when targetting remote instances we are unable to delete the files as we do not (or potentially) do not have access. If this is the case keep an eye on the log directory and remove old "SQLCover-Trace-.xel" and "SQLCover-Trace-.xem" files."<p>Thanks.</article><div class=sharethis-inline-share-buttons></div><div id=disqus_thread></div><script>(function(){var n=document,t=n.createElement("script");t.src="//eapyl-github-io.disqus.com/embed.js";t.setAttribute("data-timestamp",+new Date);(n.head||n.body).appendChild(t)})()</script></div></div></div><script async src=prism.js></script><script>(function(n,t,i,r,u,f,e){n.GoogleAnalyticsObject=u;n[u]=n[u]||function(){(n[u].q=n[u].q||[]).push(arguments)};n[u].l=1*new Date;f=t.createElement(i);e=t.getElementsByTagName(i)[0];f.async=1;f.src=r;e.parentNode.insertBefore(f,e)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create","UA-87583712-1","auto");ga("send","pageview")</script><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5906f3ca75e4e1001109c19a&product=inline-share-buttons"></script>