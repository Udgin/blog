<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title> - Use WebSQL and IndexedDB in Typescript</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Notes</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;">Notes</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="http://127.0.0.1:1111/use-websql-and-indexeddb-in-typescript/#in-memory-implementation" class="toc-link">In Memory implementation</a>
                    
                </li>
                
                <li>
                    <a href="http://127.0.0.1:1111/use-websql-and-indexeddb-in-typescript/#websql-implementation" class="toc-link">WebSQL implementation</a>
                    
                </li>
                
                <li>
                    <a href="http://127.0.0.1:1111/use-websql-and-indexeddb-in-typescript/#indexeddb-implementation" class="toc-link">IndexedDB implementation</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;use-websql-and-indexeddb-in-typescript&#x2F;">Use WebSQL and IndexedDB in Typescript</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2016-10-25</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>More information about <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDb</a> or <a href="https://www.w3.org/TR/webdatabase/">WebSQL</a>.</p>
<p>Let's define base interfaces for our task:</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">export interface </span><span style="color:#c0c5ce;">IItem {</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">id</span><span style="color:#c0c5ce;">: string;</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">: string;</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">export interface </span><span style="color:#c0c5ce;">IStorage&lt;T </span><span style="color:#b48ead;">extends </span><span style="color:#c0c5ce;">IItem&gt; {</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">// Initial method to create storage</span><span style="color:#c0c5ce;">
    </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: string): Observable&lt;IStorage&lt;T&gt;&gt;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">// Get the value by unique key</span><span style="color:#c0c5ce;">
    </span><span style="color:#8fa1b3;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">: string): Observable&lt;T&gt;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">// Clear/remove all data in the storage</span><span style="color:#c0c5ce;">
    </span><span style="color:#8fa1b3;">clear</span><span style="color:#c0c5ce;">(): Observable&lt;T&gt;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">// Put specific value into the storage</span><span style="color:#c0c5ce;">
    </span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">: T): Observable&lt;T&gt;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">// Get all values using the set of keys</span><span style="color:#c0c5ce;">
    </span><span style="color:#8fa1b3;">getDenseBatch</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">keys</span><span style="color:#c0c5ce;">: string[]): Observable&lt;T&gt;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">// Get all values from the storage</span><span style="color:#c0c5ce;">
    </span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">(): Observable&lt;T&gt;;</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span></pre>
<p>Here I am using <a href="http://reactivex.io/">rxjs</a> to handle results. IItem is an interface for items which we are saving, IStorage is an interface for a specific storage.</p>
<h3 id="in-memory-implementation">In Memory implementation</h3>
<p>A short example how to implement mentioned interface using in-memory array:</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">export class </span><span style="color:#ebcb8b;">MemoryStorage</span><span style="color:#eff1f5;">&lt;T </span><span style="color:#b48ead;">extends </span><span style="color:#eff1f5;">IItem&gt; </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">IStorage</span><span style="color:#eff1f5;">&lt;T&gt; {</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">{ [</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string]</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">T } </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">{};</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;MemoryStorage&lt;T&gt;&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">of</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">of</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">storage</span><span style="color:#eff1f5;">[</span><span style="color:#bf616a;">key</span><span style="color:#eff1f5;">]);</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">clear</span><span style="color:#c0c5ce;">(): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">{};</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">empty</span><span style="color:#eff1f5;">&lt;T&gt;();</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">T</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">!</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">.id) {</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">.id </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">Math.</span><span style="color:#96b5b4;">random</span><span style="color:#eff1f5;">().</span><span style="color:#96b5b4;">toString</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">36</span><span style="color:#eff1f5;">).</span><span style="color:#96b5b4;">substring</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">7</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
        }</span><span style="color:#eff1f5;">
        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">storage</span><span style="color:#eff1f5;">[</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">.id] </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">of</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">getDenseBatch</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">keys</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string[]</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">from</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">keys</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">x </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">storage</span><span style="color:#eff1f5;">[</span><span style="color:#bf616a;">x</span><span style="color:#eff1f5;">]));</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">(): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">from</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Object</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">keys</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">storage</span><span style="color:#eff1f5;">).</span><span style="color:#8fa1b3;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">x </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">storage</span><span style="color:#eff1f5;">[</span><span style="color:#bf616a;">x</span><span style="color:#eff1f5;">]));</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
}</span><span style="color:#c0c5ce;">
</span></pre>
<p>Simple implementation of IItem:</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">TestKeyValue </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">IItem </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">public </span><span style="color:#bf616a;">id</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string;</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">public </span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string;</span><span style="color:#eff1f5;">
}</span><span style="color:#c0c5ce;">
</span></pre>
<p>Unit tests for MemoryStorage:</p>
<pre style="background-color:#2b303b;">
<span style="color:#8fa1b3;">describe</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">MemoryStorage: Class</span><span style="color:#c0c5ce;">&#39;, () </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">key1 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">key1</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#bf616a;">key2 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">key2</span><span style="color:#c0c5ce;">&#39;;</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">value1</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">value2</span><span style="color:#c0c5ce;">&#39;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(): MemoryStorage&lt;TestKeyValue&gt; {</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new MemoryStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test</span><span style="color:#c0c5ce;">&#39;);</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
  }</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should create empty storage</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeTruthy</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save one item</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">({ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">});</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeFalsy</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save/get one item</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">item </span><span style="color:#c0c5ce;">= { id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">};</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">item</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toEqual</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">item</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save/get two items</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">items </span><span style="color:#c0c5ce;">= [{ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}, { id: </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">}];</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">getDenseBatch</span><span style="color:#c0c5ce;">([</span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">]).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toEqual</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">++]));</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should clear saved items</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">items </span><span style="color:#c0c5ce;">= [{ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}, { id: </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">}];</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">clear</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeTruthy</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
});</span><span style="color:#c0c5ce;">
</span></pre><h3 id="websql-implementation">WebSQL implementation</h3>
<p>Current implementation just just for objects where key (string) is unique string value, value (string) is a payload.</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">export class </span><span style="color:#ebcb8b;">WebSQLStorage</span><span style="color:#eff1f5;">&lt;T </span><span style="color:#b48ead;">extends </span><span style="color:#eff1f5;">IItem&gt; </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">IStorage</span><span style="color:#eff1f5;">&lt;T&gt; {</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#bf616a;">db</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Database;</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#bf616a;">databaseName</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">TripNoteDB</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">constructor</span><span style="color:#c0c5ce;">() </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">db </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">window.</span><span style="color:#8fa1b3;">openDatabase</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">databaseName</span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">1.0</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">`</span><span style="color:#a3be8c;">Store information</span><span style="color:#c0c5ce;">`</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">40 </span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">1024 </span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">1024</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;WebSQLStorage&lt;T&gt;&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">name</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;WebSQLStorage&lt;T&gt;&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#eff1f5;">
                </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">tx</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">tx</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">executeSql</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">`</span><span style="color:#a3be8c;">CREATE TABLE IF NOT EXISTS ${</span><span style="color:#bf616a;">name</span><span style="color:#a3be8c;">} (key unique, value string)</span><span style="color:#c0c5ce;">`</span><span style="color:#eff1f5;">,</span><span style="color:#eff1f5;">
                    [],</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">results</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    },</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">message</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">toString</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    })</span><span style="color:#eff1f5;">
            );</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">tx</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">tx</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">executeSql</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">`</span><span style="color:#a3be8c;">SELECT * FROM ${</span><span style="color:#bf616a;">this</span><span style="color:#a3be8c;">.name} WHERE key=&#39;${</span><span style="color:#bf616a;">key</span><span style="color:#a3be8c;">}&#39;</span><span style="color:#c0c5ce;">`</span><span style="color:#eff1f5;">, [],</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">results</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">len </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">results</span><span style="color:#eff1f5;">.rows.length;</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">len </span><span style="color:#c0c5ce;">=== </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
                            </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">undefined</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                        } </span><span style="color:#b48ead;">else if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">len </span><span style="color:#c0c5ce;">=== </span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
                            </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">results</span><span style="color:#eff1f5;">.rows.</span><span style="color:#96b5b4;">item</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">));</span><span style="color:#eff1f5;">
                        } </span><span style="color:#b48ead;">else </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                            </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">There should be no more than one entry</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                        }</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    },</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">message</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">toString</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    });</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">clear</span><span style="color:#c0c5ce;">() </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">tx</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">tx</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">executeSql</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">`</span><span style="color:#a3be8c;">DELETE FROM ${</span><span style="color:#bf616a;">this</span><span style="color:#a3be8c;">.name}</span><span style="color:#c0c5ce;">`</span><span style="color:#eff1f5;">, [], </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">r</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">(), </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">toString</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                });</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">(): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">tx</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">tx</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">executeSql</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">`</span><span style="color:#a3be8c;">SELECT * FROM ${</span><span style="color:#bf616a;">this</span><span style="color:#a3be8c;">.name}</span><span style="color:#c0c5ce;">`</span><span style="color:#eff1f5;">,</span><span style="color:#eff1f5;">
                    [],</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">results</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">for </span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">; </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">&lt; </span><span style="color:#bf616a;">results</span><span style="color:#eff1f5;">.rows.length; </span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">++</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
                            </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">results</span><span style="color:#eff1f5;">.rows.</span><span style="color:#96b5b4;">item</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">i</span><span style="color:#eff1f5;">));</span><span style="color:#eff1f5;">
                        }</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    },</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">message</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">toString</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    });</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">T</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">tx</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">tx</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">executeSql</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">`</span><span style="color:#a3be8c;">INSERT OR REPLACE INTO ${</span><span style="color:#bf616a;">this</span><span style="color:#a3be8c;">.name} VALUES (?, ?)</span><span style="color:#c0c5ce;">`</span><span style="color:#eff1f5;">, [</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">.id, </span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">.value],</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    },</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">toString</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    });</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">getDenseBatch</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">keys</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string[]</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">keys</span><span style="color:#eff1f5;">.length </span><span style="color:#c0c5ce;">=== </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">empty</span><span style="color:#eff1f5;">&lt;T&gt;();</span><span style="color:#eff1f5;">
        };</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T[]&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">tx</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">key </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">keys</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">x </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#96b5b4;">\&#39;</span><span style="color:#c0c5ce;">&#39; + </span><span style="color:#bf616a;">x </span><span style="color:#c0c5ce;">+ &#39;</span><span style="color:#96b5b4;">\&#39;</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">).</span><span style="color:#96b5b4;">join</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">,</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">tx</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">executeSql</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">`</span><span style="color:#a3be8c;">SELECT * FROM ${</span><span style="color:#bf616a;">this</span><span style="color:#a3be8c;">.name} WHERE key IN (${</span><span style="color:#bf616a;">key</span><span style="color:#a3be8c;">})</span><span style="color:#c0c5ce;">`</span><span style="color:#eff1f5;">,</span><span style="color:#eff1f5;">
                    [],</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">results</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">for </span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">; </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">&lt; </span><span style="color:#bf616a;">results</span><span style="color:#eff1f5;">.rows.length; </span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">++</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
                            </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">results</span><span style="color:#eff1f5;">.rows.</span><span style="color:#96b5b4;">item</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">i</span><span style="color:#eff1f5;">));</span><span style="color:#eff1f5;">
                        }</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    },</span><span style="color:#eff1f5;">
                    </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">t</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">message</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">toString</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    });</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
}</span><span style="color:#c0c5ce;">
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#8fa1b3;">describe</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">WebSQLStorage: Class</span><span style="color:#c0c5ce;">&#39;, () </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">key1 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">key1</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#bf616a;">key2 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">key2</span><span style="color:#c0c5ce;">&#39;;</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">value1</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">value2</span><span style="color:#c0c5ce;">&#39;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should create empty storage</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new WebSQLStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test1</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeTruthy</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save one item </span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new WebSQLStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test2</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">({ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
        </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeFalsy</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
      });</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save/get one item</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new WebSQLStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test3</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">item </span><span style="color:#c0c5ce;">= { id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">};</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">item</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
        </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
          </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.value).</span><span style="color:#8fa1b3;">toEqual</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">item</span><span style="color:#c0c5ce;">.value);</span><span style="color:#c0c5ce;">
        });</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
      });</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save/get two items</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new WebSQLStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test4</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">items </span><span style="color:#c0c5ce;">= [{ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}, { id: </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">}];</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">])</span><span style="color:#c0c5ce;">
      .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">])</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
          </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
          </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">getDenseBatch</span><span style="color:#c0c5ce;">([</span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">])</span><span style="color:#c0c5ce;">
            .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.value).</span><span style="color:#8fa1b3;">toEqual</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">++].value));</span><span style="color:#c0c5ce;">
        }));</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should clear saved items</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">async</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new WebSQLStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test5</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">items </span><span style="color:#c0c5ce;">= [{ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}, { id: </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">}];</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">])</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">zip</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]))</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">clear</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
          </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeTruthy</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
        }));</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  }));</span><span style="color:#c0c5ce;">
});</span><span style="color:#c0c5ce;">
</span></pre><h3 id="indexeddb-implementation">IndexedDB implementation</h3>
<p>How to use IndexedDB is <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB">here</a>.
There are very useful <a href="https://www.codeproject.com/articles/744986/how-to-do-some-magic-with-indexeddb">tricks</a>.</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">export class </span><span style="color:#ebcb8b;">IndexedDBStorage</span><span style="color:#eff1f5;">&lt;T </span><span style="color:#b48ead;">extends </span><span style="color:#eff1f5;">IItem&gt; </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">IStorage</span><span style="color:#eff1f5;">&lt;T&gt; {</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#bf616a;">databaseName</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">TripNoteDB</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#8fa1b3;">getDb</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">version</span><span style="color:#c0c5ce;">?: </span><span style="color:#eff1f5;">number, </span><span style="color:#bf616a;">storeName</span><span style="color:#c0c5ce;">?: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;IDBDatabase&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;number&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">req </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">version </span><span style="color:#c0c5ce;">&amp;&amp; </span><span style="color:#bf616a;">version </span><span style="color:#c0c5ce;">&gt; </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">? </span><span style="color:#eff1f5;">window.</span><span style="color:#bf616a;">indexedDB</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">open</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">databaseName</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">version</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
                </span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">window.</span><span style="color:#bf616a;">indexedDB</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">open</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">databaseName</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onsuccess </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">db </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">(&lt;any&gt;event.target).</span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">close</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
            };</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onupgradeneeded </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">db </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">(&lt;any&gt;</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.target).</span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">storeName </span><span style="color:#c0c5ce;">&amp;&amp; !</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">objectStoreNames</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">contains</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">storeName</span><span style="color:#eff1f5;">)) {</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">createObjectStore</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">storeName</span><span style="color:#eff1f5;">, { keyPath: </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">id</span><span style="color:#c0c5ce;">&#39; </span><span style="color:#eff1f5;">});</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">transaction </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">(&lt;any&gt;</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.target).</span><span style="color:#bf616a;">transaction</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">transaction</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">oncomplete </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">event</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">close</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    };</span><span style="color:#eff1f5;">
                };</span><span style="color:#eff1f5;">
            };</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onblocked </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">event</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">IndexedDB is blocked</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onerror </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">private </span><span style="color:#8fa1b3;">getVersionOfDb</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;number&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getDb</span><span style="color:#eff1f5;">().</span><span style="color:#8fa1b3;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">!</span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">objectStoreNames</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">contains</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name)) {</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.version </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
            } </span><span style="color:#b48ead;">else </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.version;</span><span style="color:#eff1f5;">
            }</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;IndexedDBStorage&lt;T&gt;&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">name</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;IndexedDBStorage&lt;T&gt;&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getVersionOfDb</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">name</span><span style="color:#eff1f5;">).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">version</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getDb</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">version</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">name</span><span style="color:#eff1f5;">).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                });</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">(): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getDb</span><span style="color:#eff1f5;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">req </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name, </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">readwrite</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">).</span><span style="color:#8fa1b3;">objectStore</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name)</span><span style="color:#eff1f5;">
                    .</span><span style="color:#8fa1b3;">openCursor</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onsuccess </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">res </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">(&lt;any&gt;event.target).</span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">res</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">res</span><span style="color:#eff1f5;">.value);</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">res</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">continue</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    }</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                };</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onerror </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getDb</span><span style="color:#eff1f5;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">req </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name).</span><span style="color:#8fa1b3;">objectStore</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name).</span><span style="color:#96b5b4;">get</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">key</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onerror </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onsuccess </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                };</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">clear</span><span style="color:#c0c5ce;">(): </span><span style="color:#eff1f5;">Observable&lt;IStorage&lt;T&gt;&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;IStorage&lt;T&gt;&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getDb</span><span style="color:#eff1f5;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">req </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name, </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">readwrite</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">).</span><span style="color:#8fa1b3;">objectStore</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name).</span><span style="color:#96b5b4;">clear</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onerror </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onsuccess </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                };</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">T</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getDb</span><span style="color:#eff1f5;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">req </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name, </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">readwrite</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#eff1f5;">).</span><span style="color:#8fa1b3;">objectStore</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name).</span><span style="color:#8fa1b3;">put</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onerror </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                };</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onsuccess </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">value</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
                    </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                };</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#8fa1b3;">getDenseBatch</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">keys</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">string[]</span><span style="color:#c0c5ce;">): </span><span style="color:#eff1f5;">Observable&lt;T&gt; {</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">Observable</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">create</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">observer</span><span style="color:#c0c5ce;">: </span><span style="color:#eff1f5;">Observer&lt;T&gt;</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">getDb</span><span style="color:#eff1f5;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">db </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">set </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">keys</span><span style="color:#eff1f5;">.</span><span style="color:#96b5b4;">sort</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">req </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">db</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">transaction</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name).</span><span style="color:#8fa1b3;">objectStore</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.name)</span><span style="color:#eff1f5;">
                    .</span><span style="color:#8fa1b3;">openCursor</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onsuccess </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">cursor </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">(&lt;any&gt;event.target).</span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">!</span><span style="color:#bf616a;">cursor</span><span style="color:#eff1f5;">) { </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">(); </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;">; }</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">key </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">cursor</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">key</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">while </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">key </span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">set</span><span style="color:#eff1f5;">[</span><span style="color:#bf616a;">i</span><span style="color:#eff1f5;">]) {</span><span style="color:#eff1f5;">
                        </span><span style="color:#65737e;">// The cursor has passed beyond this key. Check next.</span><span style="color:#eff1f5;">
                        </span><span style="color:#c0c5ce;">++</span><span style="color:#bf616a;">i</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">=== </span><span style="color:#bf616a;">set</span><span style="color:#eff1f5;">.length) {</span><span style="color:#eff1f5;">
                            </span><span style="color:#65737e;">// There is no next. Stop searching.</span><span style="color:#eff1f5;">
                            </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">complete</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                            </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
                        }</span><span style="color:#eff1f5;">
                    }</span><span style="color:#eff1f5;">
                    </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">key </span><span style="color:#c0c5ce;">=== </span><span style="color:#bf616a;">set</span><span style="color:#eff1f5;">[</span><span style="color:#bf616a;">i</span><span style="color:#eff1f5;">]) {</span><span style="color:#eff1f5;">
                        </span><span style="color:#65737e;">// The current cursor value should be included and we should continue</span><span style="color:#eff1f5;">
                        </span><span style="color:#65737e;">// a single step in case next item has the same key or possibly our</span><span style="color:#eff1f5;">
                        </span><span style="color:#65737e;">// next key in set.</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">next</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">cursor</span><span style="color:#eff1f5;">.value);</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">cursor</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">continue</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
                    } </span><span style="color:#b48ead;">else </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
                        </span><span style="color:#65737e;">// cursor.key not yet at set[i]. Forward cursor to the next key to hunt for.</span><span style="color:#eff1f5;">
                        </span><span style="color:#bf616a;">cursor</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">continue</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">set</span><span style="color:#eff1f5;">[</span><span style="color:#bf616a;">i</span><span style="color:#eff1f5;">]);</span><span style="color:#eff1f5;">
                    }</span><span style="color:#eff1f5;">
                };</span><span style="color:#eff1f5;">
                </span><span style="color:#bf616a;">req</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">onerror </span><span style="color:#c0c5ce;">= (</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">observer</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">error</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
            });</span><span style="color:#eff1f5;">
        });</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
}</span><span style="color:#c0c5ce;">
</span></pre>
<p>Unit tests for indexedDB:</p>
<pre style="background-color:#2b303b;">
<span style="color:#8fa1b3;">describe</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">IndexedDBStorage: Class</span><span style="color:#c0c5ce;">&#39;, () </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">key1 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">key1</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#bf616a;">key2 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">key2</span><span style="color:#c0c5ce;">&#39;;</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">value1</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">value2</span><span style="color:#c0c5ce;">&#39;;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should create empty storage</span><span style="color:#c0c5ce;">&#39;, (</span><span style="color:#bf616a;">done</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new IndexedDBStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test1</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
        </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeTruthy</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
        </span><span style="color:#8fa1b3;">done</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
      });</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  });</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save one item </span><span style="color:#c0c5ce;">&#39;, (</span><span style="color:#bf616a;">done</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new IndexedDBStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test2</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">({ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
        </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
          </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeFalsy</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
          </span><span style="color:#8fa1b3;">done</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
        });</span><span style="color:#c0c5ce;">
      });</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  });</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save/get one item</span><span style="color:#c0c5ce;">&#39;, (</span><span style="color:#bf616a;">done</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new IndexedDBStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test3</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">item </span><span style="color:#c0c5ce;">= { id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">};</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">item</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
        </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
          </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toEqual</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">item</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
          </span><span style="color:#8fa1b3;">done</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
        });</span><span style="color:#c0c5ce;">
      });</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  });</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should save/get two items</span><span style="color:#c0c5ce;">&#39;, (</span><span style="color:#bf616a;">done</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new IndexedDBStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test4</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">items </span><span style="color:#c0c5ce;">= [{ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}, { id: </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">}];</span><span style="color:#c0c5ce;">
      </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">item1 </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">])</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">merge</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">])).</span><span style="color:#8fa1b3;">last</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">y </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
          </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">getDenseBatch</span><span style="color:#c0c5ce;">([</span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">]).</span><span style="color:#8fa1b3;">toArray</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">x </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
            </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">x</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]).</span><span style="color:#8fa1b3;">toEqual</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
            </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">x</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]).</span><span style="color:#8fa1b3;">toEqual</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
            </span><span style="color:#8fa1b3;">done</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
          });</span><span style="color:#c0c5ce;">
        });</span><span style="color:#c0c5ce;">
      });</span><span style="color:#c0c5ce;">
  });</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">it</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">should clear saved items</span><span style="color:#c0c5ce;">&#39;, (</span><span style="color:#bf616a;">done</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">storage </span><span style="color:#c0c5ce;">= new IndexedDBStorage&lt;TestKeyValue&gt;();</span><span style="color:#c0c5ce;">
    </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">init</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">test5</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">items </span><span style="color:#c0c5ce;">= [{ id: </span><span style="color:#bf616a;">key1</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value1 </span><span style="color:#c0c5ce;">}, { id: </span><span style="color:#bf616a;">key2</span><span style="color:#c0c5ce;">, value: </span><span style="color:#bf616a;">value2 </span><span style="color:#c0c5ce;">}];</span><span style="color:#c0c5ce;">
      </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">])</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">merge</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">items</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">])).</span><span style="color:#8fa1b3;">last</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
        .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">x </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">clear</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
          .</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">y </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">storage</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">all</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">isEmpty</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">subscribe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny </span><span style="color:#b48ead;">=&gt; </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
              </span><span style="color:#8fa1b3;">expect</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">isAny</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">toBeTruthy</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
              </span><span style="color:#8fa1b3;">done</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
            })));</span><span style="color:#c0c5ce;">
    });</span><span style="color:#c0c5ce;">
  });</span><span style="color:#c0c5ce;">
});</span><span style="color:#c0c5ce;">
</span></pre>
    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;tags&#x2F;javascript&#x2F;">#javascript</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;xamarin-dev-days-in-warsaw&#x2F;">‹ Xamarin Dev Days in Warsaw</a>
                    
                    
                        <a class="next" href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;octave-tutorial&#x2F;">Octave Tutorial ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;even.js" ></script>
      
    <script src="/livereload.js?port=1000&mindelay=10"></script></body>

</html>
