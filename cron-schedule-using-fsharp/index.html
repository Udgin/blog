<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Notes - Cron schedule using F#</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Notes</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;">Notes</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://eapyl.github.io/cron-schedule-using-fsharp/#i-started-with-rewriting-cron-scheduling" class="toc-link">I started with rewriting cron scheduling.</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;cron-schedule-using-fsharp&#x2F;">Cron schedule using F#</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2017-06-01</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>I decided to start learning fsharp and hope I will be able to use F# in my future small projects.</p>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<p>Currently I have a small service worked in Docker container. It is written using C# on dotnet core.
This service is for grabbing data from external services via HTTP and putting aggregated data to InfluxDB database. Internally the service is using cron to plan and run this process as we want to grab data periodically.</p>
<h4 id="i-started-with-rewriting-cron-scheduling">I started with rewriting cron scheduling.</h4>
<p>So there is implementation in F# below:</p>
<p>Let's start with two helper objects: <code>String.split</code> and <code>TooMuchArgumentsException</code> exception.</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">type </span><span style="color:#c0c5ce;">System.String with 
    </span><span style="color:#b48ead;">static member </span><span style="color:#bf616a;">split c </span><span style="color:#b48ead;">(</span><span style="color:#bf616a;">value</span><span style="color:#b48ead;">: </span><span style="color:#c0c5ce;">string</span><span style="color:#b48ead;">) =</span><span style="color:#c0c5ce;">
        value.Split c

</span><span style="color:#b48ead;">exception</span><span style="color:#c0c5ce;"> TooMuchArgumentsException </span><span style="color:#b48ead;">of </span><span style="color:#c0c5ce;">int
</span></pre>
<p><code>String.split</code> is just wrapper for <code>String.Split</code> method. Exception is needed to show when cron expression contains too much parts.</p>
<p>My internal cron supports the next template: 'minute hour dayOfMonth month dayOfWeek'. And the next type of cron expressions: </p>
<ol>
<li>'*' - wildcard;</li>
<li>'*/5' - every 5th, e.g. every five minutes;</li>
<li>'10-20/5' - range value, e.g. every from 10 till 20, e.g. every minute from 10 till 20. '/5' is optional and it works the same as previous one, so '10-20/5' for minutes means run at 10, 15 and 20;</li>
<li>'5' - one value only, e.g. only at 5th minute</li>
<li>'5,10,15,45' - list value, e.g. run at 5th, 10th, 15th and 45th minutes</li>
</ol>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">open </span><span style="color:#8fa1b3;">System
</span><span style="color:#b48ead;">open </span><span style="color:#8fa1b3;">System.Text.RegularExpressions

</span><span style="color:#b48ead;">module </span><span style="color:#8fa1b3;">Schedule </span><span style="color:#b48ead;">=
    </span><span style="color:#65737e;">// regexp for */5
    </span><span style="color:#96b5b4;">[&lt;Literal&gt;]
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">DividePattern </span><span style="color:#b48ead;">= </span><span style="color:#c0c5ce;">@&quot;</span><span style="color:#a3be8c;">(\*/\d+)</span><span style="color:#c0c5ce;">&quot;
    </span><span style="color:#65737e;">// regexp for range
    </span><span style="color:#96b5b4;">[&lt;Literal&gt;]
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">RangePattern </span><span style="color:#b48ead;">= </span><span style="color:#c0c5ce;">@&quot;</span><span style="color:#a3be8c;">(\d+\-\d+(/\d+)?)</span><span style="color:#c0c5ce;">&quot;
    </span><span style="color:#65737e;">// regexp for wild char
    </span><span style="color:#96b5b4;">[&lt;Literal&gt;]
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">WildPattern </span><span style="color:#b48ead;">= </span><span style="color:#c0c5ce;">@&quot;</span><span style="color:#a3be8c;">(\*)</span><span style="color:#c0c5ce;">&quot;
    </span><span style="color:#65737e;">// regexp for one value
    </span><span style="color:#96b5b4;">[&lt;Literal&gt;]
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">OneValuePattern </span><span style="color:#b48ead;">= </span><span style="color:#c0c5ce;">@&quot;</span><span style="color:#a3be8c;">(\d)</span><span style="color:#c0c5ce;">&quot;
    </span><span style="color:#65737e;">// regexp for list value
    </span><span style="color:#96b5b4;">[&lt;Literal&gt;]
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">ListPattern </span><span style="color:#b48ead;">= </span><span style="color:#c0c5ce;">@&quot;</span><span style="color:#a3be8c;">((\d+,)+\d+)</span><span style="color:#c0c5ce;">&quot;

    </span><span style="color:#65737e;">// internal record to parsed cron expression, so it contains minutes,
    // hours, days of month, months and day of week when we should run our jobs
    </span><span style="color:#b48ead;">type </span><span style="color:#c0c5ce;">ISchedueSet </span><span style="color:#b48ead;">= 
        {</span><span style="color:#c0c5ce;"> 
            Minutes</span><span style="color:#b48ead;">: </span><span style="color:#c0c5ce;">int list</span><span style="color:#b48ead;">;</span><span style="color:#c0c5ce;">
            Hours</span><span style="color:#b48ead;">: </span><span style="color:#c0c5ce;">int list</span><span style="color:#b48ead;">;</span><span style="color:#c0c5ce;">
            DayOfMonth</span><span style="color:#b48ead;">: </span><span style="color:#c0c5ce;">int list</span><span style="color:#b48ead;">;</span><span style="color:#c0c5ce;">
            Months</span><span style="color:#b48ead;">: </span><span style="color:#c0c5ce;">int list</span><span style="color:#b48ead;">;</span><span style="color:#c0c5ce;">
            DayOfWeek</span><span style="color:#b48ead;">: </span><span style="color:#c0c5ce;">int list
        </span><span style="color:#b48ead;">}
    
    </span><span style="color:#65737e;">// method to generate ISchedueSet record from cron expression
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">generate expression </span><span style="color:#b48ead;">=
        </span><span style="color:#65737e;">// internal method to parse */5 
        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">dividedArray </span><span style="color:#b48ead;">(</span><span style="color:#bf616a;">m</span><span style="color:#b48ead;">:</span><span style="color:#c0c5ce;">string</span><span style="color:#b48ead;">)</span><span style="color:#bf616a;"> start max </span><span style="color:#b48ead;">=
            let </span><span style="color:#bf616a;">divisor </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> m </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;">  String.split </span><span style="color:#b48ead;">[|</span><span style="color:#a3be8c;">&#39;/&#39;</span><span style="color:#b48ead;">|] |&gt;</span><span style="color:#c0c5ce;"> Array.skip </span><span style="color:#d08770;">1 </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;"> Array.head </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;"> Int32.Parse
            </span><span style="color:#b48ead;">[</span><span style="color:#c0c5ce;">start </span><span style="color:#b48ead;">..</span><span style="color:#c0c5ce;"> max</span><span style="color:#b48ead;">] |&gt;</span><span style="color:#c0c5ce;"> List.filter </span><span style="color:#b48ead;">(fun</span><span style="color:#bf616a;"> x </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> x % divisor </span><span style="color:#b48ead;">= </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">)
        </span><span style="color:#65737e;">// internal method to parse range
        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">rangeArray </span><span style="color:#b48ead;">(</span><span style="color:#bf616a;">m</span><span style="color:#b48ead;">:</span><span style="color:#c0c5ce;">string</span><span style="color:#b48ead;">) =
            let </span><span style="color:#bf616a;">split </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> m </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;"> String.split </span><span style="color:#b48ead;">[|</span><span style="color:#a3be8c;">&#39;-&#39;</span><span style="color:#b48ead;">; </span><span style="color:#a3be8c;">&#39;/&#39;</span><span style="color:#b48ead;">|] |&gt;</span><span style="color:#c0c5ce;"> Array.map Int32.Parse
            </span><span style="color:#b48ead;">match</span><span style="color:#c0c5ce;"> Array.length split </span><span style="color:#b48ead;">with
                | </span><span style="color:#d08770;">2 </span><span style="color:#b48ead;">-&gt; [</span><span style="color:#c0c5ce;">split.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">] ..</span><span style="color:#c0c5ce;"> split.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">]]
                | </span><span style="color:#d08770;">3 </span><span style="color:#b48ead;">-&gt; [</span><span style="color:#c0c5ce;">split.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">] ..</span><span style="color:#c0c5ce;"> split.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">]] |&gt;</span><span style="color:#c0c5ce;"> List.filter </span><span style="color:#b48ead;">(fun</span><span style="color:#bf616a;"> x </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> x % split.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">2</span><span style="color:#b48ead;">] = </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">)
                | _ -&gt; []
        </span><span style="color:#65737e;">// internal method to parse wild char
        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">wildArray </span><span style="color:#b48ead;">(</span><span style="color:#bf616a;">m</span><span style="color:#b48ead;">:</span><span style="color:#c0c5ce;">string</span><span style="color:#b48ead;">)</span><span style="color:#bf616a;"> start max </span><span style="color:#b48ead;">=
            [</span><span style="color:#c0c5ce;">start </span><span style="color:#b48ead;">..</span><span style="color:#c0c5ce;"> max</span><span style="color:#b48ead;">]
        </span><span style="color:#65737e;">// internal method to parse single value
        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">oneValue </span><span style="color:#b48ead;">(</span><span style="color:#bf616a;">m</span><span style="color:#b48ead;">:</span><span style="color:#c0c5ce;">string</span><span style="color:#b48ead;">) =
            [</span><span style="color:#c0c5ce;">m </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;"> Int32.Parse</span><span style="color:#b48ead;">]
        </span><span style="color:#65737e;">// internal method to parse list value
        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">listArray </span><span style="color:#b48ead;">(</span><span style="color:#bf616a;">m</span><span style="color:#b48ead;">:</span><span style="color:#c0c5ce;">string</span><span style="color:#b48ead;">) =</span><span style="color:#c0c5ce;">
            m </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;"> String.split </span><span style="color:#b48ead;">[|</span><span style="color:#a3be8c;">&#39;,&#39;</span><span style="color:#b48ead;">|] |&gt;</span><span style="color:#c0c5ce;"> Array.map Int32.Parse </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;"> Array.toList
        
        </span><span style="color:#65737e;">// we need to set minimum and maximum value for every part of date time
        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">getStartAndMax i </span><span style="color:#b48ead;">=
            match</span><span style="color:#c0c5ce;"> i </span><span style="color:#b48ead;">with
            </span><span style="color:#65737e;">// for minutes
            </span><span style="color:#b48ead;">| </span><span style="color:#d08770;">0 </span><span style="color:#b48ead;">-&gt; (</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">59</span><span style="color:#b48ead;">)
            </span><span style="color:#65737e;">// for hours
            </span><span style="color:#b48ead;">| </span><span style="color:#d08770;">1 </span><span style="color:#b48ead;">-&gt; (</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">23</span><span style="color:#b48ead;">)
            </span><span style="color:#65737e;">// for days of month
            </span><span style="color:#b48ead;">| </span><span style="color:#d08770;">2 </span><span style="color:#b48ead;">-&gt; (</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">31</span><span style="color:#b48ead;">)
            </span><span style="color:#65737e;">// for months
            </span><span style="color:#b48ead;">| </span><span style="color:#d08770;">3 </span><span style="color:#b48ead;">-&gt; (</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">12</span><span style="color:#b48ead;">)
            </span><span style="color:#65737e;">// for day of week
            </span><span style="color:#b48ead;">| </span><span style="color:#d08770;">4 </span><span style="color:#b48ead;">-&gt; (</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">)
            </span><span style="color:#65737e;">// throw an exception if don&#39;t know for what part of date time we need values
            </span><span style="color:#b48ead;">| _ -&gt;</span><span style="color:#c0c5ce;"> raise </span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">TooMuchArgumentsException i</span><span style="color:#b48ead;">)
        
        </span><span style="color:#65737e;">// active pattern to match regexp
        </span><span style="color:#b48ead;">let (|</span><span style="color:#bf616a;">MatchRegex</span><span style="color:#b48ead;">|</span><span style="color:#bf616a;">_</span><span style="color:#b48ead;">|)</span><span style="color:#bf616a;"> pattern input </span><span style="color:#b48ead;">=
            let </span><span style="color:#bf616a;">m </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> Regex.Match</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">input</span><span style="color:#b48ead;">,</span><span style="color:#c0c5ce;"> pattern</span><span style="color:#b48ead;">)
            if</span><span style="color:#c0c5ce;"> m.Success </span><span style="color:#b48ead;">then</span><span style="color:#c0c5ce;"> Some </span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">m.ToString</span><span style="color:#d08770;">()</span><span style="color:#b48ead;">) else</span><span style="color:#c0c5ce;"> None
        
        </span><span style="color:#65737e;">// parsing cron expression and create a array of lists which contains all possibles values
        // for every part of daytime
        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">parts </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;">
            expression 
            </span><span style="color:#b48ead;">|&gt;</span><span style="color:#c0c5ce;"> String.split </span><span style="color:#b48ead;">[|</span><span style="color:#a3be8c;">&#39; &#39;</span><span style="color:#b48ead;">|]
            |&gt;</span><span style="color:#c0c5ce;"> Array.mapi </span><span style="color:#b48ead;">(fun</span><span style="color:#bf616a;"> i x </span><span style="color:#b48ead;">-&gt;
                let (</span><span style="color:#bf616a;">start</span><span style="color:#b48ead;">,</span><span style="color:#bf616a;"> max</span><span style="color:#b48ead;">) =</span><span style="color:#c0c5ce;"> getStartAndMax i 
                </span><span style="color:#b48ead;">match</span><span style="color:#c0c5ce;"> x </span><span style="color:#b48ead;">with
                    |</span><span style="color:#c0c5ce;"> MatchRegex DividePattern x </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> dividedArray x start max
                    </span><span style="color:#b48ead;">|</span><span style="color:#c0c5ce;"> MatchRegex RangePattern x </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> rangeArray x
                    </span><span style="color:#b48ead;">|</span><span style="color:#c0c5ce;"> MatchRegex WildPattern x </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> wildArray x start max
                    </span><span style="color:#b48ead;">|</span><span style="color:#c0c5ce;"> MatchRegex ListPattern x </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> listArray x
                    </span><span style="color:#b48ead;">|</span><span style="color:#c0c5ce;"> MatchRegex OneValuePattern x </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> oneValue x
                    </span><span style="color:#b48ead;">| _ -&gt; []
            )
        </span><span style="color:#65737e;">// convert list of array to ISchedueSet
        </span><span style="color:#b48ead;">{</span><span style="color:#c0c5ce;"> 
            Minutes </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> parts.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;">
            Hours </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> parts.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;">
            DayOfMonth </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> parts.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">2</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;">
            Months </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> parts.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">3</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;">
            DayOfWeek </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> parts.</span><span style="color:#b48ead;">[</span><span style="color:#d08770;">4</span><span style="color:#b48ead;">]
        }
    </span><span style="color:#65737e;">// method to check date time via generated ISchedueSet
    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">isTime schedueSet </span><span style="color:#b48ead;">(</span><span style="color:#bf616a;">dateTime </span><span style="color:#b48ead;">: </span><span style="color:#c0c5ce;">DateTime</span><span style="color:#b48ead;">) =</span><span style="color:#c0c5ce;">
        List.exists </span><span style="color:#b48ead;">((=)</span><span style="color:#c0c5ce;"> dateTime.Minute</span><span style="color:#b48ead;">)</span><span style="color:#c0c5ce;"> schedueSet.Minutes </span><span style="color:#b48ead;">&amp;&amp;</span><span style="color:#c0c5ce;"> 
        List.exists </span><span style="color:#b48ead;">((=)</span><span style="color:#c0c5ce;"> dateTime.Hour</span><span style="color:#b48ead;">)</span><span style="color:#c0c5ce;"> schedueSet.Hours </span><span style="color:#b48ead;">&amp;&amp;</span><span style="color:#c0c5ce;">
        List.exists </span><span style="color:#b48ead;">((=)</span><span style="color:#c0c5ce;"> dateTime.Day</span><span style="color:#b48ead;">)</span><span style="color:#c0c5ce;"> schedueSet.DayOfMonth </span><span style="color:#b48ead;">&amp;&amp;</span><span style="color:#c0c5ce;">
        List.exists </span><span style="color:#b48ead;">((=)</span><span style="color:#c0c5ce;"> dateTime.Month</span><span style="color:#b48ead;">)</span><span style="color:#c0c5ce;"> schedueSet.Months </span><span style="color:#b48ead;">&amp;&amp;</span><span style="color:#c0c5ce;">
        List.exists </span><span style="color:#b48ead;">((=) (</span><span style="color:#c0c5ce;">int dateTime.DayOfWeek</span><span style="color:#b48ead;">))</span><span style="color:#c0c5ce;"> schedueSet.DayOfWeek
</span></pre>
<p>So Schedule module contains two methods and one type: </p>
<ul>
<li>ISchedueSet is a container for parsed cron expression;</li>
<li>generate is to generate ISchedueSet record from cron expression. This record contains all possible values of minutes, hours, months, days of month, days of week for particular cron expression;</li>
<li>isTime is to check if we need to run a job in passed date time </li>
</ul>
<p>Small sets of unit tests written using mstest:</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">namespace </span><span style="color:#8fa1b3;">FsharpTest

</span><span style="color:#b48ead;">open </span><span style="color:#8fa1b3;">System
</span><span style="color:#b48ead;">open </span><span style="color:#8fa1b3;">Microsoft.VisualStudio.TestTools.UnitTesting
</span><span style="color:#b48ead;">open </span><span style="color:#8fa1b3;">Cron
</span><span style="color:#b48ead;">open </span><span style="color:#8fa1b3;">Schedule

</span><span style="color:#65737e;">// minute hour dayOfMonth month dayOfWeek
</span><span style="color:#96b5b4;">[&lt;TestClass&gt;]
</span><span style="color:#b48ead;">type </span><span style="color:#c0c5ce;">ScheduleTests </span><span style="color:#d08770;">() </span><span style="color:#b48ead;">=

    </span><span style="color:#96b5b4;">[&lt;TestMethod&gt;]
    </span><span style="color:#b48ead;">member </span><span style="color:#bf616a;">this.All </span><span style="color:#d08770;">() </span><span style="color:#b48ead;">=
        let </span><span style="color:#bf616a;">schedule </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> Schedule.generate &quot;</span><span style="color:#a3be8c;">* * * * *</span><span style="color:#c0c5ce;">&quot;
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfMonth </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1.</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">31</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfWeek </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0.</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">6</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Hours </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0.</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">23</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Minutes </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0.</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">59</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Months </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1.</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">12</span><span style="color:#b48ead;">]);

    </span><span style="color:#96b5b4;">[&lt;TestMethod&gt;]
    </span><span style="color:#b48ead;">member </span><span style="color:#bf616a;">this.Range </span><span style="color:#d08770;">() </span><span style="color:#b48ead;">=
        let </span><span style="color:#bf616a;">schedule </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> Schedule.generate &quot;</span><span style="color:#a3be8c;">0-5 0-10/2 10-20/3 3-5 2-6/2</span><span style="color:#c0c5ce;">&quot;
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfMonth </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">12</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">15</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">18</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfWeek </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">2</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">4</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Hours </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">2</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">4</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">8</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">10</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Minutes </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">1</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">2</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">3</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">4</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">5</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Months </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">3</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">4</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">5</span><span style="color:#b48ead;">]);

    </span><span style="color:#96b5b4;">[&lt;TestMethod&gt;]
    </span><span style="color:#b48ead;">member </span><span style="color:#bf616a;">this.OneTime </span><span style="color:#d08770;">() </span><span style="color:#b48ead;">=
        let </span><span style="color:#bf616a;">schedule </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> Schedule.generate &quot;</span><span style="color:#a3be8c;">0 0 1 1 0</span><span style="color:#c0c5ce;">&quot;
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfMonth </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfWeek </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Hours </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Minutes </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Months </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">]);

    </span><span style="color:#96b5b4;">[&lt;TestMethod&gt;]
    </span><span style="color:#b48ead;">member </span><span style="color:#bf616a;">this.Every </span><span style="color:#d08770;">() </span><span style="color:#b48ead;">=
        let </span><span style="color:#bf616a;">schedule </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> Schedule.generate &quot;</span><span style="color:#a3be8c;">*/15 */3 */2 */5 *</span><span style="color:#c0c5ce;">&quot;
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfMonth </span><span style="color:#b48ead;">[for</span><span style="color:#c0c5ce;"> i </span><span style="color:#b48ead;">in [</span><span style="color:#d08770;">1 </span><span style="color:#b48ead;">.. </span><span style="color:#d08770;">31</span><span style="color:#b48ead;">] do
                                                                if</span><span style="color:#c0c5ce;"> i%</span><span style="color:#d08770;">2 </span><span style="color:#b48ead;">= </span><span style="color:#d08770;">0 </span><span style="color:#b48ead;">then
                                                                    yield</span><span style="color:#c0c5ce;"> i</span><span style="color:#b48ead;">]
        );</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfWeek </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0 </span><span style="color:#b48ead;">.. </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Hours </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">3</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">9</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">12</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">15</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">18</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">21</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Minutes </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">15</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">30</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">45</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Months </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">5</span><span style="color:#b48ead;">; </span><span style="color:#d08770;">10</span><span style="color:#b48ead;">]);

    </span><span style="color:#96b5b4;">[&lt;TestMethod&gt;]
    </span><span style="color:#b48ead;">member </span><span style="color:#bf616a;">this.OnlySome </span><span style="color:#d08770;">() </span><span style="color:#b48ead;">=
        let </span><span style="color:#bf616a;">schedule </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> Schedule.generate &quot;</span><span style="color:#a3be8c;">1,2,3 5,6,7 28,29 1,2 5,6</span><span style="color:#c0c5ce;">&quot;
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfMonth </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">28</span><span style="color:#b48ead;">;</span><span style="color:#d08770;">29</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.DayOfWeek </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">5</span><span style="color:#b48ead;">;</span><span style="color:#d08770;">6</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Hours </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">5</span><span style="color:#b48ead;">;</span><span style="color:#d08770;">6</span><span style="color:#b48ead;">;</span><span style="color:#d08770;">7</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Minutes </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">;</span><span style="color:#d08770;">2</span><span style="color:#b48ead;">;</span><span style="color:#d08770;">3</span><span style="color:#b48ead;">]);</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">List.forall2 </span><span style="color:#b48ead;">( = )</span><span style="color:#c0c5ce;"> schedule.Months </span><span style="color:#b48ead;">[</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">;</span><span style="color:#d08770;">2</span><span style="color:#b48ead;">]);

    </span><span style="color:#96b5b4;">[&lt;TestMethod&gt;]
    </span><span style="color:#b48ead;">member </span><span style="color:#bf616a;">this.IsTime </span><span style="color:#d08770;">() </span><span style="color:#b48ead;">=
        let </span><span style="color:#bf616a;">dateTime </span><span style="color:#b48ead;">=</span><span style="color:#c0c5ce;"> DateTime</span><span style="color:#b48ead;">(</span><span style="color:#d08770;">2000</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">1</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">1</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">, </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">)
        let </span><span style="color:#bf616a;">schedule </span><span style="color:#b48ead;">= {</span><span style="color:#c0c5ce;"> Minutes </span><span style="color:#b48ead;">= [</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;"> Hours </span><span style="color:#b48ead;">= [</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;"> DayOfWeek </span><span style="color:#b48ead;">= [</span><span style="color:#d08770;">0 </span><span style="color:#b48ead;">.. </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;"> DayOfMonth </span><span style="color:#b48ead;">= [</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">];</span><span style="color:#c0c5ce;"> Months </span><span style="color:#b48ead;">= [</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">]}</span><span style="color:#c0c5ce;">
        Assert.IsTrue</span><span style="color:#b48ead;">(</span><span style="color:#c0c5ce;">Schedule.isTime schedule dateTime</span><span style="color:#b48ead;">)
</span></pre>
<p>Quite simple implementation of cron schedule part of mentioned service.</p>
<p>Thanks.</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;tags&#x2F;dotnet&#x2F;">#dotnet</a>
                    
                        <a href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;tags&#x2F;fsharp&#x2F;">#fsharp</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;cron-service-using-fsharp-on-net-core&#x2F;">‹ Cron service using F# on .NET Core</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;eapyl.github.io&#x2F;cake-net-useful-scripts-for-angularjs-dotnet-core-docker-application&#x2F;">Cake.Net. Useful scripts for AngularJS, dotnet core, docker application ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;eapyl.github.io&#x2F;even.js" ></script>
      
    </body>

</html>
